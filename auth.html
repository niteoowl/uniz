<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</title>
    
    <!-- Pretendard í°íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <!-- Google Material Symbols (ì•„ì´ì½˜) ë¶ˆëŸ¬ì˜¤ê¸° -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        /* CSS ì´ˆê¸°í™” ë° ê¸°ë³¸ ì„¤ì • */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
        }

        body, html {
            height: 100%;
            background-color: #ffffff;
            color: #1a1a1a;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }

        /* ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            transition: opacity 0.3s;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 1. ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .auth-app {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            flex-direction: column;
            background: #ffffff;
            z-index: 1000;
        }

        /* 2. í—¤ë” */
        .app-header {
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .app-header .material-symbols-outlined {
            font-size: 24px;
            cursor: pointer;
            padding-right: 15px;
        }
        .header-title {
            font-weight: 600;
            flex-grow: 1;
        }

        .header-action {
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .header-action:hover {
            opacity: 1;
        }

        /* 3. ë‹¨ê³„ë³„ í™”ë©´ ìŠ¬ë¼ì´ë”© ì»¨í…Œì´ë„ˆ */
        .step-wrapper {
            flex-grow: 1;
            width: 100%;
            display: block;
            overflow: hidden;
            padding-bottom: 80px; /* ê³ ì • ë²„íŠ¼ ê³µê°„ í™•ë³´ */
        }

        .step-container {
            display: flex;
            width: 200%; /* 2ë‹¨ê³„ */
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.3, 0.7, 0.4, 0.9);
        }

        .step-page {
            width: calc(100% / 2);
            flex-shrink: 0;
            padding: 20px 16px;
            overflow-y: auto;
            background-color: #ffffff;
        }
        
        /* 4. ê³ ì •ëœ ë‹¤ìŒ ë²„íŠ¼ ì˜ì—­ */
        .next-button-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 16px;
            background: #ffffff;
            box-shadow: none;
            z-index: 100;
        }

        .next-button {
            width: 100%;
            padding: 15px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .next-button:disabled {
            background-color: #a8cfff;
            cursor: not-allowed;
        }
        .next-button:active:not(:disabled) {
            transform: scale(0.98);
            background-color: #005bb5;
        }

        /* 5. ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .input-group {
            margin-bottom: 25px;
        }
        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
            font-size: 1.1rem;
        }
        .text-input {
            width: 100%;
            padding: 12px 10px;
            border: none;
            border-bottom: 2px solid #ccc;
            font-size: 1.2rem;
            font-weight: 600;
            transition: border-bottom-color 0.2s;
        }
        .text-input:focus {
            outline: none;
            border-bottom-color: #007aff;
        }
        
        /* 6. ëª¨ë“œ ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ìˆ˜ì…/ì§€ì¶œ í† ê¸€ ì¬í™œìš©) */
        .mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
        }
        .mode-btn {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            color: #1a1a1a;
            background-color: #f7f7f7;
            transition: all 0.2s;
        }
        .mode-btn.selected-mode {
            color: #1a1a1a;
            background-color: #ffffff;
            border-color: #1a1a1a;
            font-weight: 700;
        }
        .mode-btn:active {
            transform: scale(0.99);
        }

        /* Google Icons ì„¤ì • */
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        /* 7. Step 2 (í¼) ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .form-content {
            display: none;
        }
        .form-content.active {
            display: block;
        }
    </style>
</head>
<body>

    <!-- 0. ë¡œë”© ì˜¤ë²„ë ˆì´: Firebase ì¸ì¦ ìƒíƒœ í™•ì¸ ë™ì•ˆ í‘œì‹œ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- 1. ì „ì²´ í™”ë©´ ë‹¨ê³„í˜• ì•± ì»¨í…Œì´ë„ˆ (ì´ˆê¸°ì— display: none) -->
    <div id="authApp" class="auth-app">
        <div class="app-header">
            <!-- ë’¤ë¡œê°€ê¸°/ë‹«ê¸° ì•„ì´ì½˜ -->
            <span class="material-symbols-outlined" id="backButton" onclick="handleBack()">
                arrow_back_ios
            </span>
            <div class="header-title" id="appTitle">ë¡œê·¸ì¸/ê°€ì… ì„ íƒ (1/2)</div>
            <!-- í™•ì¸ ë²„íŠ¼ (ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œ í™œì„±í™”) -->
            <div class="header-action" id="authActionButton" onclick="authenticateUser()" style="visibility: hidden;">
                <span class="material-symbols-outlined" style="font-weight: 600;">
                    check
                </span>
            </div>
        </div>
        
        <!-- ë‹¨ê³„ë³„ í˜ì´ì§€ë¥¼ ë‹´ëŠ” ë˜í¼ -->
        <div class="step-wrapper">
            <!-- ë‚´ë¶€ ìŠ¬ë¼ì´ë”© ì»¨í…Œì´ë„ˆ -->
            <div id="stepContainer" class="step-container">
            
                <!-- 3-1. Step 1: ëª¨ë“œ ì„ íƒ (ë¡œê·¸ì¸ / íšŒì›ê°€ì…) -->
                <div class="step-page" id="step1">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">í™˜ì˜í•©ë‹ˆë‹¤! ì–´ë–¤ ì‘ì—…ì„ ì›í•˜ì„¸ìš”?</h3>
                    <p style="color: #888; margin-bottom: 30px;">ì›í•˜ëŠ” ì¸ì¦ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                    
                    <!-- ëª¨ë“œ ì„ íƒ í† ê¸€ -->
                    <div class="mode-toggle">
                        <div class="mode-btn selected-mode" id="modeLogin" onclick="selectMode('login')">ë¡œê·¸ì¸</div>
                        <div class="mode-btn" id="modeSignup" onclick="selectMode('signup')">íšŒì›ê°€ì…</div>
                    </div>

                    <div style="margin-top: 50px; padding: 15px; background: #f9f9f9; border-radius: 12px;">
                        <p style="font-weight: 600; margin-bottom: 5px;">ì„ íƒ ì •ë³´</p>
                        <p id="selectedModeText" style="color: #007aff; font-weight: 700;">ë¡œê·¸ì¸</p>
                    </div>
                </div>
                
                <!-- 3-2. Step 2: ì •ë³´ ì…ë ¥ ë° ì‹¤í–‰ -->
                <div class="step-page" id="step2">
                    <h3 id="step2Title" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</h3>
                    <p style="color: #888; margin-bottom: 30px;">ê³„ì • ì •ë³´ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    
                    <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ê³µí†µ í•„ë“œ -->
                    <div class="input-group">
                        <label for="emailInput">ì´ë©”ì¼</label>
                        <input type="email" id="emailInput" class="text-input" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" oninput="validateStep2()">
                    </div>

                    <div class="input-group">
                        <label for="passwordInput">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="passwordInput" class="text-input" placeholder="6ì ì´ìƒ ë¹„ë°€ë²ˆí˜¸" oninput="validateStep2()">
                    </div>

                    <!-- íšŒì›ê°€ì… ì „ìš© í•„ë“œ -->
                    <div id="signupOnlyFields" class="form-content" style="display: none;">
                        <div class="input-group">
                            <label for="passwordConfirmInput">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="passwordConfirmInput" class="text-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥" oninput="validateStep2()">
                        </div>
                        <div class="input-group">
                            <label for="nicknameInput">ë‹‰ë„¤ì„</label>
                            <input type="text" id="nicknameInput" class="text-input" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„" oninput="validateStep2()">
                        </div>
                    </div>

                    <div id="authErrorMsg" style="color: #e74c3c; margin-top: 20px; font-weight: 600;"></div>
                </div>

            </div>
        </div>

        <!-- 4. í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì˜ì—­ -->
        <div class="next-button-fixed">
            <button class="next-button" id="nextButton" onclick="nextStep()" disabled>ë‹¤ìŒ</button>
        </div>
    </div>
    
    <!-- Custom Message Box (alert() ëŒ€ì²´) -->
    <div id="custom-message" style="
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background-color: #333;
        color: white;
        border-radius: 8px;
        z-index: 2000;
        opacity: 0;
        transition: bottom 0.3s ease-out, opacity 0.3s;
        text-align: center;
        max-width: 80%;
    "></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            updateProfile,
            setPersistence, 
            browserSessionPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const $ = (id) => document.getElementById(id);
        
        // í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, ì œê³µëœ Configë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (Canvas í™˜ê²½ì„ ìœ„í•œ ì„¤ì •)
        const userProvidedConfig = {
             // ì‹¤ì œ Firebase í”„ë¡œì íŠ¸ì˜ ì„¤ì •ìœ¼ë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤. (ë°ëª¨ìš© ê¸°ë³¸ê°’)
            apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI",
            authDomain: "pocketbly.firebaseapp.com",
            projectId: "pocketbly",
            storageBucket: "pocketbly.firebasestorage.app",
            messagingSenderId: "535063683428",
            appId: "1:535063683428:web:7308c878e7c486ca305a71",
            measurementId: "G-PK1YGPMFYF"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(userProvidedConfig));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth;
        
        // ------------------ Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ------------------
        
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                await setPersistence(auth, browserSessionPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Custom token sign-in successful.");
                } else {
                    // ìµëª… ë¡œê·¸ì¸ì€ ì´ë¯¸ ë©”ì¸ ì•±ì—ì„œ ì²˜ë¦¬ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, 
                    // ì—¬ê¸°ì„œëŠ” ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš°ë¥¼ ìœ„í•´ ìµëª… ë¡œê·¸ì¸ì„ ì‹œë„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    // ëŒ€ì‹ , onAuthStateChangedì—ì„œ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
                }

                // onAuthStateChangedëŠ” ì´ˆê¸° ë¡œë“œ ì‹œ í•œ ë²ˆ ì‹¤í–‰ë©ë‹ˆë‹¤.
                onAuthStateChanged(auth, (user) => {
                    $('loading-overlay').style.display = 'none';
                    $('authApp').style.display = 'flex';

                    if (user && !user.isAnonymous) {
                        // ì¼ë°˜ ì‚¬ìš©ì ë¡œê·¸ì¸ ìƒíƒœ -> ë©”ì¸ ì•±ìœ¼ë¡œ ì´ë™ ì‹œë®¬ë ˆì´ì…˜
                        console.log("User already logged in:", user.uid);
                        showMessage("ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                        // ì‹¤ì œ ì•±ì—ì„œëŠ” window.location.href = '/main';
                        // ë°ëª¨ë¥¼ ìœ„í•´ ì´ˆê¸°í™”ë©´(Step 1)ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                    } else if (user && user.isAnonymous) {
                         console.log("Anonymous user detected:", user.uid);
                         showMessage("ìµëª… ì‚¬ìš©ìë¡œ ì ‘ì†í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                         // ìµëª… ì‚¬ìš©ìì—ê²Œ ë¡œê·¸ì¸/íšŒì›ê°€ì… ì˜µì…˜ ì œê³µ
                    } else {
                        // ë¡œê·¸ì¸ ì•ˆ ë¨
                        console.log("No user logged in. Showing Auth screen.");
                    }
                    renderStep(); // UI ë Œë”ë§ ì‹œì‘
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                showMessage("Firebase ì—°ê²° ë˜ëŠ” ì´ˆê¸° ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        // ------------------ ì•± ë¡œì§ ì‹œì‘ í•¨ìˆ˜ ------------------

        let authState = {
            currentStep: 1,
            authMode: 'login', // 'login' ë˜ëŠ” 'signup'
            email: '',
            password: '',
            passwordConfirm: '',
            nickname: ''
        };

        const STEP_TITLES = [
            'ë¡œê·¸ì¸/ê°€ì… ì„ íƒ (1/2)',
            'ì •ë³´ ì…ë ¥ (2/2)'
        ];
        
        // ìœˆë„ìš° ë¡œë“œ ì‹œ Firebase ì´ˆê¸°í™” ì‹œì‘
        initFirebase();
        
        /**
         * í˜„ì¬ ë‹¨ê³„ì— ë”°ë¼ í—¤ë” ë° ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function renderStep() {
            const stepIndex = authState.currentStep - 1; // 0, 1
            
            // 1. í—¤ë” ì œëª© ì—…ë°ì´íŠ¸
            $('appTitle').textContent = STEP_TITLES[stepIndex];
            
            // 2. ì»¨í…Œì´ë„ˆ ìŠ¬ë¼ì´ë“œ
            $('stepContainer').style.transform = `translateX(-${stepIndex * (100 / 2)}%)`;

            // 3. ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° ê°€ì‹œì„± ì œì–´
            const actionText = authState.authMode === 'login' ? 'ë¡œê·¸ì¸' : 'ê°€ì…í•˜ê¸°';
            $('authActionButton').style.visibility = authState.currentStep === 2 ? 'visible' : 'hidden';
            $('nextButton').textContent = authState.currentStep === 2 ? actionText + ' ì‹¤í–‰' : 'ë‹¤ìŒ';
            
            // 4. ìŠ¤í…ë³„ ì¶”ê°€ ì—…ë°ì´íŠ¸
            if (authState.currentStep === 1) {
                validateStep1();
                $('nextButton').textContent = 'ë‹¤ìŒ';
            } else if (authState.currentStep === 2) {
                // Step 2 ë Œë”ë§
                const isSignup = authState.authMode === 'signup';
                
                $('step2Title').textContent = isSignup ? 'íšŒì›ê°€ì… ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.' : 'ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
                $('signupOnlyFields').style.display = isSignup ? 'block' : 'none';

                // ì…ë ¥ ê°’ ë³µì›
                $('emailInput').value = authState.email;
                $('passwordInput').value = authState.password;
                $('passwordConfirmInput').value = authState.passwordConfirm;
                $('nicknameInput').value = authState.nickname;
                
                validateStep2();
            }

            // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
            $('authErrorMsg').textContent = '';
        }

        /**
         * ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.
         */
        function nextStep() {
            if (authState.currentStep === 1) {
                // Step 1ì—ì„œëŠ” ëª¨ë“œë§Œ ì„ íƒë¨
            } else if (authState.currentStep === 2) {
                authenticateUser();
                return;
            }

            if (authState.currentStep < STEP_TITLES.length) {
                authState.currentStep++;
                renderStep();
                if (authState.currentStep === 2) {
                    $('emailInput').focus();
                }
            }
        }

        /**
         * ì´ì „ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.
         */
        function handleBack() {
            if (authState.currentStep > 1) {
                authState.currentStep--;
                renderStep();
            } else {
                showMessage('ì¸ì¦ í˜ì´ì§€ë¥¼ ë‹«ëŠ” ê¸°ëŠ¥ì€ ë°ëª¨ì—ì„œ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.');
                // ì‹¤ì œ ì•±ì—ì„œëŠ” window.history.back();
            }
        }
        
        /**
         * ë¡œê·¸ì¸ ë˜ëŠ” íšŒì›ê°€ì… ëª¨ë“œë¥¼ ì„ íƒí•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function selectMode(mode) {
            authState.authMode = mode;
            const loginBtn = $('modeLogin');
            const signupBtn = $('modeSignup');
            const selectedText = $('selectedModeText');
            
            if (mode === 'login') {
                loginBtn.classList.add('selected-mode');
                signupBtn.classList.remove('selected-mode');
                selectedText.textContent = 'ë¡œê·¸ì¸';
            } else {
                signupBtn.classList.add('selected-mode');
                loginBtn.classList.remove('selected-mode');
                selectedText.textContent = 'íšŒì›ê°€ì…';
            }
            // Step 1ì—ì„œëŠ” í•­ìƒ 'ë‹¤ìŒ' ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ìœ ì§€
            validateStep1(); 
        }

        // ------------------ ìœ íš¨ì„± ê²€ì‚¬ (ë²„íŠ¼ í™œì„±í™”) ------------------

        function validateEmail(email) {
            // ê°„ë‹¨í•œ ì´ë©”ì¼ í˜•ì‹ ê²€ì‚¬
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        function validateStep1() {
            // Step 1ì€ ëª¨ë“œë§Œ ì„ íƒí•˜ë©´ ë˜ë¯€ë¡œ í•­ìƒ í™œì„±í™”
            $('nextButton').disabled = false;
        }

        function validateStep2() {
            // ì…ë ¥ ìƒíƒœë¥¼ authStateì— ì—…ë°ì´íŠ¸
            authState.email = $('emailInput').value.trim();
            authState.password = $('passwordInput').value;
            authState.passwordConfirm = $('passwordConfirmInput').value;
            authState.nickname = $('nicknameInput').value.trim();

            const isLogin = authState.authMode === 'login';
            let isValid = true;

            // 1. ì´ë©”ì¼ ë° ë¹„ë°€ë²ˆí˜¸ í•„ìˆ˜ ê²€ì‚¬
            if (!validateEmail(authState.email)) {
                isValid = false;
            }
            if (authState.password.length < 6) {
                isValid = false;
            }

            if (isLogin) {
                // ë¡œê·¸ì¸ ëª¨ë“œ: ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ë§Œ í•„ìš”
                // ì¶”ê°€ ì¡°ê±´ ì—†ìŒ
            } else {
                // íšŒì›ê°€ì… ëª¨ë“œ: ë¹„ë°€ë²ˆí˜¸ í™•ì¸, ë‹‰ë„¤ì„ í•„ìˆ˜
                if (authState.password !== authState.passwordConfirm || authState.password.length === 0) {
                    isValid = false;
                }
                if (authState.nickname.length < 2) {
                    isValid = false;
                }
            }

            $('nextButton').disabled = !isValid;
        }
        
        // ------------------ ìµœì¢… ì¸ì¦ ì‹¤í–‰ ------------------

        async function authenticateUser() {
            $('nextButton').disabled = true;
            $('authActionButton').style.opacity = 0.5;
            $('authErrorMsg').textContent = '';
            showMessage(`${authState.authMode === 'login' ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…'} ì§„í–‰ ì¤‘...`);

            try {
                if (authState.authMode === 'login') {
                    // ë¡œê·¸ì¸ ì‹¤í–‰
                    const userCredential = await signInWithEmailAndPassword(auth, authState.email, authState.password);
                    const user = userCredential.user;

                    showMessage(`ğŸ‰ ë¡œê·¸ì¸ ì„±ê³µ! í™˜ì˜í•©ë‹ˆë‹¤, ${user.displayName || 'ì‚¬ìš©ì'}!`);
                    console.log("Login Successful:", user.uid);
                    // ì‹¤ì œ ì•±ì—ì„œëŠ” window.location.href = '/main';
                
                } else {
                    // íšŒì›ê°€ì… ì‹¤í–‰
                    const userCredential = await createUserWithEmailAndPassword(auth, authState.email, authState.password);
                    const user = userCredential.user;
                    
                    // ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸
                    await updateProfile(user, { displayName: authState.nickname });

                    showMessage(`âœ¨ íšŒì›ê°€ì… ì„±ê³µ! ${authState.nickname}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
                    console.log("Signup Successful:", user.uid);
                    // ì‹¤ì œ ì•±ì—ì„œëŠ” window.location.href = '/main';

                    // ê°€ì… í›„ ìƒíƒœ ì´ˆê¸°í™” (ì˜µì…˜: ë¡œê·¸ì¸ ìƒíƒœë¡œ ì „í™˜ëœ ì±„ë¡œ ìœ ì§€)
                }

                // ì„±ê³µ ì‹œ 2ì´ˆ í›„ ì´ˆê¸° ìƒíƒœë¡œ ë³µê·€ (ë°ëª¨ìš©)
                setTimeout(() => {
                    authState.currentStep = 1;
                    selectMode('login');
                    authState.email = '';
                    authState.password = '';
                    authState.stateConfirm = '';
                    authState.nickname = '';
                    renderStep();
                }, 2000);

            } catch (error) {
                console.error("Authentication Error:", error);
                
                let errorMessage = 'ì¸ì¦ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                
                // Firebase ì—ëŸ¬ ì½”ë“œ ê¸°ë°˜ ë©”ì‹œì§€
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                        break;
                    default:
                        errorMessage = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                }
                
                $('authErrorMsg').textContent = errorMessage;
                showMessage(`âŒ ${errorMessage}`);
                validateStep2(); // ì—ëŸ¬ ë°œìƒ ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™” í•´ì œ
            } finally {
                $('nextButton').disabled = false;
                $('authActionButton').style.opacity = 1;
            }
        }
        
        // ------------------ ìœ í‹¸ë¦¬í‹° ------------------
        
        /**
         * alert() ëŒ€ì‹  ì‚¬ìš©í•  ì‚¬ìš©ì ì •ì˜ ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showMessage(message) {
            const msgBox = $('custom-message');
            msgBox.textContent = message;
            
            msgBox.style.bottom = '20px';
            msgBox.style.opacity = '1';

            setTimeout(() => {
                msgBox.style.bottom = '-100px';
                msgBox.style.opacity = '0';
            }, 2000);
        }
    </script>
</body>
</html>
