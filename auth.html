<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ ë° íšŒì›ê°€ì…</title>
    
    <!-- Pretendard í°íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <!-- Google Material Symbols (ì•„ì´ì½˜) ë¶ˆëŸ¬ì˜¤ê¸° -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        /* CSS ì´ˆê¸°í™” ë° ê¸°ë³¸ ì„¤ì • */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
        }

        body, html {
            height: 100%;
            background-color: #ffffff;
            color: #1a1a1a;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }

        /* ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            transition: opacity 0.3s;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 1. ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .auth-app {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            flex-direction: column;
            background: #ffffff;
            z-index: 1000;
        }

        /* 2. í—¤ë” */
        .app-header {
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .app-header .material-symbols-outlined {
            font-size: 24px;
            cursor: pointer;
            padding-right: 15px;
        }
        .header-title {
            font-weight: 600;
            flex-grow: 1;
            text-align: center; /* ì œëª©ì„ ì¤‘ì•™ ì •ë ¬ */
            margin-right: 24px; /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ê³µê°„ í™•ë³´ */
        }
        /* Step 3ì—ì„œ ì œëª© ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ back button paddingì„ 0ìœ¼ë¡œ ì„¤ì • */
        .app-header .material-symbols-outlined[style*="visibility: hidden"] {
             padding-right: 0;
        }


        /* 3. ë‹¨ê³„ë³„ í™”ë©´ ìŠ¬ë¼ì´ë”© ì»¨í…Œì´ë„ˆ */
        .step-wrapper {
            flex-grow: 1;
            width: 100%;
            display: block;
            overflow: hidden;
            padding-bottom: 80px; /* ê³ ì • ë²„íŠ¼ ê³µê°„ í™•ë³´ */
        }

        .step-container {
            display: flex;
            /* 3ë‹¨ê³„ì´ë¯€ë¡œ 300% */
            width: 300%; 
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.3, 0.7, 0.4, 0.9);
        }

        .step-page {
            width: calc(100% / 3);
            flex-shrink: 0;
            padding: 20px 16px;
            overflow-y: auto;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
        }
        
        /* 4. ê³ ì •ëœ ë‹¤ìŒ ë²„íŠ¼ ì˜ì—­ */
        .next-button-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 16px;
            background: #ffffff;
            box-shadow: none;
            z-index: 100;
        }

        .next-button {
            width: 100%;
            padding: 15px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .next-button:disabled {
            background-color: #a8cfff;
            cursor: not-allowed;
        }
        .next-button:active:not(:disabled) {
            transform: scale(0.98);
            background-color: #005bb5;
        }

        /* 5. ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .input-group {
            margin-bottom: 25px;
        }
        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
            font-size: 1.1rem;
        }
        .text-input {
            width: 100%;
            padding: 12px 10px;
            border: none;
            border-bottom: 2px solid #ccc;
            font-size: 1.2rem;
            font-weight: 600;
            transition: border-bottom-color 0.2s;
        }
        .text-input:focus {
            outline: none;
            border-bottom-color: #007aff;
        }
        
        /* ìœ íš¨ì„± ê²€ì‚¬ í”¼ë“œë°± */
        .input-feedback {
            font-size: 0.85rem;
            color: #ff3b30; /* ë¹¨ê°„ìƒ‰ ê²½ê³  */
            margin-top: 5px;
            display: none;
        }

        /* 6. ëª¨ë“œ ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .mode-toggle {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 50px;
        }
        .mode-btn {
            padding: 25px;
            border: 1px solid #eee;
            border-radius: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            color: #1a1a1a;
            background-color: #f7f7f7;
            transition: all 0.2s;
        }
        .mode-btn.selected-mode {
            background-color: #e6f0ff; 
            border-color: #007aff;
            color: #007aff;
        }
        .mode-btn:active {
            transform: scale(0.98);
        }

        /* 7. Step 3 (ì™„ë£Œ) í™”ë©´ ìŠ¤íƒ€ì¼ */
        #step3.step-page {
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .success-icon {
            font-size: 64px;
            color: #34c759; /* ë…¹ìƒ‰ */
            margin-bottom: 20px;
            font-variation-settings: 'FILL' 1;
        }
        .success-message h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .success-message p {
            color: #888;
            font-size: 1.1rem;
        }
        .header-action {
             visibility: hidden; /* ì €ì¥ ë²„íŠ¼ì€ ì¸ì¦ í˜ì´ì§€ì—ì„œëŠ” í•„ìš” ì—†ìŒ */
        }

        /* Google Icons ì„¤ì • */
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
</head>
<body>

    <!-- 0. ë¡œë”© ì˜¤ë²„ë ˆì´: Firebase ì¸ì¦ ìƒíƒœ í™•ì¸ ë™ì•ˆ í‘œì‹œ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- 1. ì „ì²´ í™”ë©´ ë‹¨ê³„í˜• ì•± ì»¨í…Œì´ë„ˆ (ì´ˆê¸°ì— display: none) -->
    <div id="authApp" class="auth-app">
        <div class="app-header">
            <!-- ë’¤ë¡œê°€ê¸°/ë‹«ê¸° ì•„ì´ì½˜ -->
            <span class="material-symbols-outlined" id="backButton" onclick="handleBack()">
                arrow_back_ios
            </span>
            <div class="header-title" id="appTitle">ëª¨ë“œ ì„ íƒ (1/3)</div>
            <!-- ë¹ˆ ê³µê°„ ìœ ì§€ (í—¤ë” ì•¡ì…˜) -->
            <div class="header-action" id="headerAction"></div>
        </div>
        
        <!-- ë‹¨ê³„ë³„ í˜ì´ì§€ë¥¼ ë‹´ëŠ” ë˜í¼ -->
        <div class="step-wrapper">
            <!-- ë‚´ë¶€ ìŠ¬ë¼ì´ë”© ì»¨í…Œì´ë„ˆ -->
            <div id="stepContainer" class="step-container">
            
                <!-- 3-1. Step 1: ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë“œ ì„ íƒ -->
                <div class="step-page" id="step1">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•œ ì²« ë‹¨ê³„ì…ë‹ˆë‹¤.</h3>
                    <p style="color: #888; margin-bottom: 30px;">ê¸°ì¡´ ì‚¬ìš©ìì¸ê°€ìš”? ìƒˆë¡œìš´ ê³„ì •ì„ ë§Œë“¤ê¹Œìš”?</p>
                    
                    <div class="mode-toggle">
                        <div class="mode-btn" id="modeLogin" data-mode="login" onclick="selectMode('login')">
                            ë¡œê·¸ì¸
                        </div>
                        <div class="mode-btn" id="modeSignup" data-mode="signup" onclick="selectMode('signup')">
                            íšŒì›ê°€ì… (ìƒˆ ê³„ì • ë§Œë“¤ê¸°)
                        </div>
                    </div>

                    <!-- Step 1 ìœ íš¨ì„± ê²€ì‚¬ (ë²„íŠ¼ í™œì„±í™”ë¥¼ ìœ„í•œ dummy input) -->
                    <input type="hidden" id="modeSelection" onchange="validateStep1()">
                </div>
                
                <!-- 3-2. Step 2: ì‚¬ìš©ì ì •ë³´ ì…ë ¥ (ëª¨ë“œì— ë”°ë¼ ë‚´ìš© ë³€ê²½) -->
                <div class="step-page" id="step2">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;" id="step2Title">ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</h3>
                    <p style="color: #888; margin-bottom: 30px;" id="step2Subtitle">ì•ˆì „í•œ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ì •í™•í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    
                    <div class="input-group">
                        <label for="emailInput">ì´ë©”ì¼</label>
                        <input type="email" id="emailInput" class="text-input" placeholder="example@email.com" 
                                oninput="validateStep2()" autocomplete="off">
                        <div id="emailFeedback" class="input-feedback">ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                    </div>

                    <div class="input-group">
                        <label for="passwordInput">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="passwordInput" class="text-input" placeholder="8ì ì´ìƒ" 
                                oninput="validateStep2()" autocomplete="off">
                        <div id="passwordFeedback" class="input-feedback">ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.</div>
                    </div>

                    <!-- íšŒì›ê°€ì… ëª¨ë“œì—ì„œë§Œ ë³´ì´ëŠ” í•„ë“œ -->
                    <div class="input-group" id="confirmPasswordGroup" style="display: none;">
                        <label for="confirmPasswordInput">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" id="confirmPasswordInput" class="text-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" 
                                oninput="validateStep2()" autocomplete="off">
                        <div id="confirmPasswordFeedback" class="input-feedback">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
                
                <!-- 3-3. Step 3: ì™„ë£Œ í™”ë©´ -->
                <div class="step-page" id="step3">
                    <div class="success-icon">
                        <span class="material-symbols-outlined" style="font-size: 64px;">
                            check_circle
                        </span>
                    </div>
                    <div class="success-message">
                        <h3 id="completionMessage">ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                        <p id="completionSubmessage">ì´ì œ ì„œë¹„ìŠ¤ë¥¼ ììœ ë¡­ê²Œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì˜ì—­ -->
        <div class="next-button-fixed">
            <button class="next-button" id="nextButton" onclick="nextStep()" disabled>ë‹¤ìŒ</button>
        </div>
    </div>
    
    <!-- Custom Message Box (alert() ëŒ€ì²´) -->
    <div id="custom-message" style="
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background-color: #333;
        color: white;
        border-radius: 8px;
        z-index: 2000;
        opacity: 0;
        transition: bottom 0.3s ease-out, opacity 0.3s;
        text-align: center;
        max-width: 80%;
    "></div>

    <script type="module">
        // Firebase Auth ë° App ëª¨ë“ˆë§Œ í•„ìš”
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            setPersistence, 
            browserSessionPersistence,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        const $ = (id) => document.getElementById(id);
        
        // ì‚¬ìš©ì ì œê³µ ì„¤ì • (í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ì„ ê²½ìš° ëŒ€ë¹„í•œ Mock Config)
        const userProvidedConfig = {
             // ì´ ì„¤ì •ì€ Canvas í™˜ê²½ì—ì„œ ìë™ ì£¼ì…ë˜ë©°, ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œìš©ì…ë‹ˆë‹¤.
             apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI",
             authDomain: "pocketbly.firebaseapp.com",
             projectId: "pocketbly",
             storageBucket: "pocketbly.firebasestorage.app",
             messagingSenderId: "535063683428",
             appId: "1:535063683428:web:7308c878e7c486ca305a71",
             measurementId: "G-PK1YGPMFYF"
        };
        
        // í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(userProvidedConfig));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth;
        let authStateChecked = false; // ì¸ì¦ ìƒíƒœ í™•ì¸ í”Œë˜ê·¸

        // ------------------ Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ------------------
        
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                await setPersistence(auth, browserSessionPersistence);

                // ì´ˆê¸° ì¸ì¦ ìƒíƒœ í™•ì¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                onAuthStateChanged(auth, (user) => {
                    if (!authStateChecked) {
                        authStateChecked = true;
                        if (user) {
                            // ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì -> ë©”ì¸ ì•±ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ (ë°ëª¨)
                            console.log("Existing user authenticated:", user.uid);
                            showMessage("ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë©”ì¸ ì•±ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤. (ë°ëª¨)");
                            // ì‹¤ì œ ì•±ì—ì„œëŠ” window.location.href = '/main';
                            startApp();
                        } else {
                            // ë¡œê·¸ì¸ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œë„
                            if (initialAuthToken) {
                                signInWithCustomToken(auth, initialAuthToken)
                                    .then(() => console.log("Custom token sign-in successful."))
                                    .catch((error) => {
                                        console.error("Custom token sign-in failed:", error);
                                        // í† í° ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ìµëª… ë¡œê·¸ì¸ ì‹œë„
                                        signInAnonymously(auth);
                                    });
                            } else {
                                // ìµëª… ë¡œê·¸ì¸ ì‹œë„ (ì¸ì¦ í˜ì´ì§€ê°€ ìµëª… ë¡œê·¸ì¸ í—ˆìš© ì‹œ)
                                signInAnonymously(auth);
                            }
                            
                            // ë¡œë”© ì œê±° ë° ì•± í™”ë©´ í‘œì‹œ
                            startApp();
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Firebase ì—°ê²° ë˜ëŠ” ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì•±ì„ í‘œì‹œí•˜ì—¬ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ê°€ëŠ¥í•˜ê²Œ í•¨
                startApp();
            }
        }
        
        // ------------------ ì•± ë¡œì§ ì‹œì‘ í•¨ìˆ˜ ------------------

        function startApp() {
            // ë¡œë”© ì˜¤ë²„ë ˆì´ ì œê±° ë° ì•± í™”ë©´ í‘œì‹œ
            $('loading-overlay').style.display = 'none';
            $('authApp').style.display = 'flex';
            
            // ì²« ë‹¨ê³„ ë Œë”ë§
            renderStep();
        }

        // ------------------ ë‹¨ê³„ ê´€ë¦¬ ìƒíƒœ ------------------

        let authState = {
            currentStep: 1,
            mode: null, // 'login' ë˜ëŠ” 'signup'
            email: '',
            password: '',
            confirmPassword: '',
        };

        const STEP_TITLES = [
            'ëª¨ë“œ ì„ íƒ (1/3)',
            'ì •ë³´ ì…ë ¥ (2/3)',
            'ì¸ì¦ ì™„ë£Œ (3/3)'
        ];

        // ------------------ ì´ˆê¸°í™” í˜¸ì¶œ ------------------
        initFirebase();

        /**
         * í˜„ì¬ ë‹¨ê³„ì— ë”°ë¼ í—¤ë” ë° ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function renderStep() {
            const stepIndex = authState.currentStep - 1; // 0, 1, 2
            
            // 1. í—¤ë” ì œëª© ì—…ë°ì´íŠ¸
            $('appTitle').textContent = STEP_TITLES[stepIndex];
            
            // 2. ì»¨í…Œì´ë„ˆ ìŠ¬ë¼ì´ë“œ
            $('stepContainer').style.transform = `translateX(-${stepIndex * (100 / 3)}%)`;

            // 3. ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° ê°€ì‹œì„± ì œì–´
            $('nextButton').textContent = authState.currentStep === 1 ? 'ë‹¤ìŒ' : 
                                         (authState.currentStep === 2 ? (authState.mode === 'login' ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì… ì™„ë£Œ') : 'ë©”ì¸ìœ¼ë¡œ ì´ë™');

            // Step 3ì—ì„œëŠ” ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ìˆ¨ê¹€
            $('backButton').style.visibility = authState.currentStep === 3 ? 'hidden' : 'visible';

            // 4. ìŠ¤í…ë³„ ì¶”ê°€ ì—…ë°ì´íŠ¸
            if (authState.currentStep === 1) {
                validateStep1();
            } else if (authState.currentStep === 2) {
                // ëª¨ë“œì— ë”°ë¼ Step 2 UI ì¡°ì •
                const isSignup = authState.mode === 'signup';
                $('confirmPasswordGroup').style.display = isSignup ? 'block' : 'none';
                $('step2Title').textContent = isSignup ? 'ìƒˆ ê³„ì • ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';

                // ì´ì „ ì…ë ¥ ê°’ ë³µì›
                $('emailInput').value = authState.email;
                $('passwordInput').value = authState.password;
                $('confirmPasswordInput').value = authState.confirmPassword;
                
                validateStep2();
            }
        }

        /**
         * ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•˜ê±°ë‚˜ ì¸ì¦ì„ ì‹œë„í•©ë‹ˆë‹¤.
         */
        async function nextStep() {
            if (authState.currentStep === 1) {
                if (authState.mode) {
                    authState.currentStep++;
                    renderStep();
                }
            } else if (authState.currentStep === 2) {
                // Step 2: ì¸ì¦ ì²˜ë¦¬ ë¡œì§
                if (!validateStep2(true)) {
                    showMessage('í•„ìˆ˜ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // ë²„íŠ¼ ë¹„í™œì„±í™” (ë¡œë”© ì¤‘ í‘œì‹œ)
                $('nextButton').disabled = true;
                $('nextButton').textContent = 'ì²˜ë¦¬ ì¤‘...';
                
                const email = authState.email;
                const password = authState.password;

                try {
                    if (authState.mode === 'login') {
                        await signInWithEmailAndPassword(auth, email, password);
                        $('completionMessage').textContent = 'ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                        $('completionSubmessage').textContent = 'ì´ì œ ì„œë¹„ìŠ¤ë¥¼ ììœ ë¡­ê²Œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    } else { // signup
                        await createUserWithEmailAndPassword(auth, email, password);
                        $('completionMessage').textContent = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                        $('completionSubmessage').textContent = 'í™˜ì˜í•©ë‹ˆë‹¤! ì§€ê¸ˆ ë°”ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    }
                    
                    // ì„±ê³µ ì‹œ Step 3ë¡œ ì´ë™
                    authState.currentStep++;
                    renderStep();
                    showMessage('âœ… ì¸ì¦ ì„±ê³µ!');
                    
                } catch (error) {
                    console.error("Authentication Error:", error);
                    let errorMessage = 'ì¸ì¦ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMessage = 'ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'ì‚¬ìš©ì´ ì •ì§€ëœ ê³„ì •ì…ë‹ˆë‹¤.';
                            break;
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                            errorMessage = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                            break;
                        case 'auth/email-already-in-use':
                            errorMessage = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                            break;
                        default:
                            errorMessage = `ì˜¤ë¥˜: ${error.message}`;
                    }
                    showMessage(`ğŸš¨ ${errorMessage}`);
                    
                    // ì—ëŸ¬ ë°œìƒ ì‹œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                    $('nextButton').disabled = false;
                    $('nextButton').textContent = authState.mode === 'login' ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì… ì™„ë£Œ';
                }

            } else if (authState.currentStep === 3) {
                // Step 3: ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™ (ë°ëª¨ì—ì„œëŠ” ë©”ì‹œì§€ í‘œì‹œ)
                showMessage('ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤. (ë°ëª¨)');
                // window.location.href = '/main'; // ì‹¤ì œ ì•±ì—ì„œ ì‚¬ìš©
            }
        }

        /**
         * ì´ì „ ë‹¨ê³„ë¡œ ì´ë™í•˜ê±°ë‚˜ ì•±ì„ ë‹«ëŠ” ë™ì‘ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         */
        function handleBack() {
            if (authState.currentStep > 1) {
                authState.currentStep--;
                renderStep();
            } else {
                showMessage('ì•±ì„ ë‹«ê³  ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. (ë°ëª¨)');
                // ì‹¤ì œ ì•±ì—ì„œëŠ” window.history.back();
            }
        }
        
        /**
         * ë¡œê·¸ì¸ ë˜ëŠ” íšŒì›ê°€ì… ëª¨ë“œë¥¼ ì„ íƒí•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function selectMode(mode) {
            authState.mode = mode;
            
            // ëª¨ë“  ë²„íŠ¼ì—ì„œ ì„ íƒ í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('selected-mode'));

            // ì„ íƒëœ ë²„íŠ¼ì— í´ë˜ìŠ¤ ì¶”ê°€
            if (mode === 'login') {
                $('modeLogin').classList.add('selected-mode');
            } else if (mode === 'signup') {
                $('modeSignup').classList.add('selected-mode');
            }
            
            // Step 1 ìœ íš¨ì„± ê²€ì‚¬ íŠ¸ë¦¬ê±°
            $('modeSelection').dispatchEvent(new Event('change'));
        }

        // ------------------ ìœ íš¨ì„± ê²€ì‚¬ (ë²„íŠ¼ í™œì„±í™”) ------------------

        function isValidEmail(email) {
            // ê°„ë‹¨í•œ ì´ë©”ì¼ í˜•ì‹ ê²€ì‚¬ (ë” ê°•ë ¥í•œ ì •ê·œì‹ë„ ê°€ëŠ¥)
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function validateStep1() {
            $('nextButton').disabled = authState.mode === null;
        }

        function validateStep2(isSubmit = false) {
            const email = $('emailInput').value.trim();
            const password = $('passwordInput').value;
            const confirmPassword = $('confirmPasswordInput').value;
            const isSignup = authState.mode === 'signup';
            
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            authState.email = email;
            authState.password = password;
            authState.confirmPassword = confirmPassword;

            let isValid = true;

            // 1. ì´ë©”ì¼ ê²€ì¦
            const emailValid = isValidEmail(email);
            if (emailValid) {
                $('emailFeedback').style.display = 'none';
            } else if (isSubmit || email.length > 0) {
                $('emailFeedback').style.display = 'block';
                isValid = false;
            }

            // 2. ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ ê²€ì¦
            const passwordValid = password.length >= 8;
            if (passwordValid) {
                $('passwordFeedback').style.display = 'none';
            } else if (isSubmit || password.length > 0) {
                $('passwordFeedback').style.display = 'block';
                isValid = false;
            }

            // 3. íšŒì›ê°€ì… ëª¨ë“œì¼ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ê²€ì¦
            if (isSignup) {
                const confirmPasswordValid = password === confirmPassword && password.length > 0;
                if (confirmPasswordValid) {
                    $('confirmPasswordFeedback').style.display = 'none';
                } else if (isSubmit || confirmPassword.length > 0) {
                    $('confirmPasswordFeedback').style.display = 'block';
                    isValid = false;
                }
                
                // íšŒì›ê°€ì…ì€ ì„¸ ê°€ì§€ ì¡°ê±´ ëª¨ë‘ ì¶©ì¡±í•´ì•¼ í•¨
                $('nextButton').disabled = !(emailValid && passwordValid && confirmPasswordValid);
            } else {
                // ë¡œê·¸ì¸ ëª¨ë“œëŠ” ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ë§Œ ì¶©ì¡±í•˜ë©´ ë¨
                $('nextButton').disabled = !(emailValid && passwordValid);
            }
            
            return isValid;
        }

        // ------------------ ìœ í‹¸ë¦¬í‹° ------------------
        
        /**
         * alert() ëŒ€ì‹  ì‚¬ìš©í•  ì‚¬ìš©ì ì •ì˜ ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showMessage(message) {
            const msgBox = $('custom-message');
            msgBox.textContent = message;
            
            msgBox.style.bottom = '20px';
            msgBox.style.opacity = '1';

            setTimeout(() => {
                msgBox.style.bottom = '-100px';
                msgBox.style.opacity = '0';
            }, 3000);
        }

        // ì „ì—­ ìŠ¤ì½”í”„ì— í•¨ìˆ˜ ë…¸ì¶œ (HTML ì¸ë¼ì¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ìš©)
        window.handleBack = handleBack;
        window.nextStep = nextStep;
        window.selectMode = selectMode;
        window.validateStep1 = validateStep1;
        window.validateStep2 = validateStep2;
    </script>
</body>
</html>
