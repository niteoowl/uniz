<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸/íšŒì›ê°€ì…</title>
    
    <!-- Pretendard í°íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <!-- Google Material Symbols (ì•„ì´ì½˜) ë¶ˆëŸ¬ì˜¤ê¸° -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        /* CSS ì´ˆê¸°í™” ë° ê¸°ë³¸ ì„¤ì • */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', sans-serif;
        }

        body, html {
            height: 100%;
            background-color: #ffffff;
            color: #1a1a1a;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }

        /* ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            transition: opacity 0.3s;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 1. ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .auth-app {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            flex-direction: column;
            background: #ffffff;
            z-index: 1000;
        }

        /* 2. í—¤ë” */
        .app-header {
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .app-header .material-symbols-outlined {
            font-size: 24px;
            cursor: pointer;
            padding-right: 15px;
        }
        .header-title {
            font-weight: 600;
            flex-grow: 1;
        }

        .header-action {
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .header-action:hover {
            opacity: 1;
        }

        /* 3. ë‹¨ê³„ë³„ í™”ë©´ ìŠ¬ë¼ì´ë”© ì»¨í…Œì´ë„ˆ */
        .step-wrapper {
            flex-grow: 1;
            width: 100%;
            display: block;
            overflow: hidden;
            padding-bottom: 80px; /* ê³ ì • ë²„íŠ¼ ê³µê°„ í™•ë³´ */
        }

        .step-container {
            display: flex;
            width: 300%;
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.3, 0.7, 0.4, 0.9);
        }

        .step-page {
            width: calc(100% / 3);
            height: 100%; /* ìˆ˜ì •: Step 3ê°€ í° í™”ë©´ìœ¼ë¡œ ë³´ì´ëŠ” í˜„ìƒ ë°©ì§€ */
            flex-shrink: 0;
            padding: 20px 16px;
            overflow-y: auto;
            background-color: #ffffff;
        }
        
        /* 4. ê³ ì •ëœ ë‹¤ìŒ ë²„íŠ¼ ì˜ì—­ */
        .next-button-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px 16px;
            background: #ffffff;
            box-shadow: none; /* ê·¸ë¦¼ì ì œê±° */
            z-index: 100;
        }

        .next-button {
            width: 100%;
            padding: 15px;
            background-color: #007aff; /* íŒŒë€ìƒ‰ìœ¼ë¡œ í†µì¼ */
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .next-button:disabled {
            background-color: #a8cfff; /* ë¹„í™œì„±í™” ì‹œ ì—°í•œ íŒŒë€ìƒ‰ */
            cursor: not-allowed;
        }
        .next-button:active:not(:disabled) {
            transform: scale(0.98);
            background-color: #005bb5;
        }

        /* 5. ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .input-group {
            margin-bottom: 25px;
        }
        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
            font-size: 1.1rem;
        }
        .text-input {
            width: 100%;
            padding: 12px 10px;
            border: none;
            border-bottom: 2px solid #ccc;
            font-size: 1.2rem;
            font-weight: 600;
            transition: border-bottom-color 0.2s;
        }
        .text-input:focus {
            outline: none;
            border-bottom-color: #007aff;
        }
        
        /* Google Icons ì„¤ì • */
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
</head>
<body>

    <!-- 0. ë¡œë”© ì˜¤ë²„ë ˆì´: Firebase ì¸ì¦ ìƒíƒœ í™•ì¸ ë™ì•ˆ í‘œì‹œ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="color: #555; font-size: 0.9rem;">ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...</p>
    </div>

    <!-- 1. ì „ì²´ í™”ë©´ ë‹¨ê³„í˜• ì•± ì»¨í…Œì´ë„ˆ (ì´ˆê¸°ì— display: none) -->
    <div id="authApp" class="auth-app">
        <div class="app-header">
            <!-- ë’¤ë¡œê°€ê¸°/ë‹«ê¸° ì•„ì´ì½˜ -->
            <span class="material-symbols-outlined" id="backButton" onclick="handleBack()">
                close
            </span>
            <div class="header-title" id="appTitle">ì´ë©”ì¼ ì…ë ¥ (1/3)</div>
            <!-- ì €ì¥ ë²„íŠ¼ (ì¸ì¦ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ìˆ¨ê¹€) -->
            <div class="header-action" id="actionButton" onclick="handleAction()" style="visibility: hidden;">
                <span class="material-symbols-outlined" style="font-weight: 600;">
                    check
                </span>
            </div>
        </div>
        
        <!-- ë‹¨ê³„ë³„ í˜ì´ì§€ë¥¼ ë‹´ëŠ” ë˜í¼ -->
        <div class="step-wrapper">
            <!-- ë‚´ë¶€ ìŠ¬ë¼ì´ë”© ì»¨í…Œì´ë„ˆ -->
            <div id="stepContainer" class="step-container">
            
                <!-- 3-1. Step 1: ì´ë©”ì¼ ì…ë ¥ -->
                <div class="step-page" id="step1">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">ì‹œì‘í•˜ë ¤ë©´ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.</h3>
                    <p style="color: #888; margin-bottom: 30px;">ê¸°ì¡´ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê±°ë‚˜ ìƒˆ ê³„ì •ì„ ë§Œë“­ë‹ˆë‹¤.</p>
                    
                    <div class="input-group">
                        <label for="emailInput">ì´ë©”ì¼ ì£¼ì†Œ</label>
                        <input type="email" id="emailInput" class="text-input" placeholder="example@email.com" oninput="validateStep1()" autocomplete="email">
                    </div>
                </div>
                
                <!-- 3-2. Step 2: ë¡œê·¸ì¸ (ì´ë©”ì¼ í™•ì¸ í›„ ê¸°ì¡´ ì‚¬ìš©ìì¼ ë•Œ) -->
                <div class="step-page" id="step2">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ë¡œê·¸ì¸í•˜ì„¸ìš”.</h3>
                    <p id="loginEmailDisplay" style="color: #007aff; font-weight: 600; margin-bottom: 30px;">
                        <!-- ì´ë©”ì¼ í‘œì‹œ ì˜ì—­ -->
                    </p>

                    <div class="input-group">
                        <label for="passwordLogin">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="passwordLogin" class="text-input" placeholder="ë¹„ë°€ë²ˆí˜¸" oninput="validateStep2()">
                    </div>
                </div>
                
                <!-- 3-3. Step 3: íšŒì›ê°€ì… (ì´ë©”ì¼ í™•ì¸ í›„ ì‹ ê·œ ì‚¬ìš©ìì¼ ë•Œ) -->
                <div class="step-page" id="step3">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">ìƒˆ ê³„ì •ì„ ë§Œë“­ë‹ˆë‹¤.</h3>
                    <p id="signupEmailDisplay" style="color: #007aff; font-weight: 600; margin-bottom: 30px;">
                        <!-- ì´ë©”ì¼ í‘œì‹œ ì˜ì—­ -->
                    </p>

                    <div class="input-group">
                        <label for="passwordSignup">ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
                        <input type="password" id="passwordSignup" class="text-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" oninput="validateStep3()" autocomplete="new-password">
                    </div>

                    <div class="input-group">
                        <label for="nameInput">ì´ë¦„ (ì„ íƒ ì‚¬í•­)</label>
                        <input type="text" id="nameInput" class="text-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ ì‚¬í•­)" oninput="validateStep3()">
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì˜ì—­ -->
        <div class="next-button-fixed">
            <button class="next-button" id="nextButton" onclick="nextStep()" disabled>ë‹¤ìŒ</button>
        </div>
    </div>
    
    <!-- Custom Message Box (alert() ëŒ€ì²´) -->
    <div id="custom-message" style="
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background-color: #333;
        color: white;
        border-radius: 8px;
        z-index: 2000;
        opacity: 0;
        transition: bottom 0.3s ease-out, opacity 0.3s;
        text-align: center;
        max-width: 80%;
    "></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, 
                 fetchSignInMethodsForEmail, signInWithEmailAndPassword, 
                 createUserWithEmailAndPassword, updateProfile, 
                 signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const $ = (id) => document.getElementById(id);
        
        // Firebase ì„¤ì • (í™˜ê²½ ë³€ìˆ˜ê°€ ì œê³µë˜ì§€ ì•Šì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ëŒ€ì²´ê°’ ì‚¬ìš©)
        const userProvidedConfig = {
            apiKey: "AIzaSyBwn6nH3yiscgy5Oa2pbqJ83Nx7YwFjlJI",
            authDomain: "pocketbly.firebaseapp.com",
            projectId: "pocketbly",
            storageBucket: "pocketbly.firebasestorage.app",
            messagingSenderId: "535063683428",
            appId: "1:535063683428:web:7308c878e7c486ca305a71",
            measurementId: "G-PK1YGPMFYF"
        };
        
        // Canvas í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš© ë° íŒŒì‹±
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(userProvidedConfig));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth;
        
        // ------------------ Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ê´€ë¦¬ ------------------
        
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                // Custom Token ë¡œê·¸ì¸ ì‹œë„
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Custom Tokenìœ¼ë¡œ ë¡œê·¸ì¸ ì„±ê³µ.");
                    } catch (error) {
                        console.error("Custom Token ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                        $('loading-text').textContent = 'ì¸ì¦ í† í° ì˜¤ë¥˜. ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                        // ìµëª… ë¡œê·¸ì¸ ì‚¬ìš© ì•ˆ í•¨ (ìš”êµ¬ì‚¬í•­)
                    }
                }
                
                // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ: ì¸ì¦ ì—¬ë¶€ì— ë”°ë¼ UI í‘œì‹œ
                onAuthStateChanged(auth, (user) => {
                    $('loading-overlay').style.display = 'none';

                    if (user && user.email) {
                        // Custom Token ë˜ëŠ” ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ëœ ê²½ìš°
                        showMessage(`ë¡œê·¸ì¸ë¨: ${user.email} (${user.uid})`);
                        // ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ì•± UIë¥¼ ìˆ¨ê¸°ê³ , ë©”ì¸ ì•±ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ëŠ” ë¡œì§ì´ í•„ìš”í•¨.
                        // ì´ ë°ëª¨ì—ì„œëŠ” ì¼ë‹¨ UIë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                        $('authApp').style.display = 'none';
                    } else {
                        // ì¸ì¦ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ë¡œê·¸ì¸ UI í‘œì‹œ
                        $('authApp').style.display = 'flex';
                        startAuthFlow();
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showMessage("Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                $('loading-overlay').style.display = 'none';
            }
        }
        
        // ------------------ ì•± ìƒíƒœ ë° ë¡œì§ ------------------

        let authState = {
            currentStep: 1, // 1: Email, 2: Login, 3: Signup
            email: '',
        };

        const STEP_TITLES = [
            'ì´ë©”ì¼ ì…ë ¥ (1/3)',
            'ë¡œê·¸ì¸ (2/3)',
            'íšŒì›ê°€ì… (3/3)'
        ];
        
        function startAuthFlow() {
            renderStep();
            $('emailInput').focus();
        }

        /**
         * í˜„ì¬ ë‹¨ê³„ì— ë”°ë¼ í—¤ë” ë° ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function renderStep() {
            const stepIndex = authState.currentStep - 1; // 0, 1, 2
            
            // 1. í—¤ë” ì œëª© ì—…ë°ì´íŠ¸
            $('appTitle').textContent = STEP_TITLES[stepIndex];
            
            // 2. ì»¨í…Œì´ë„ˆ ìŠ¬ë¼ì´ë“œ
            $('stepContainer').style.transform = `translateX(-${stepIndex * (100 / 3)}%)`;

            // 3. ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° ìœ íš¨ì„± ê²€ì‚¬
            let buttonText = 'ë‹¤ìŒ';
            
            if (authState.currentStep === 2) {
                buttonText = 'ë¡œê·¸ì¸';
                $('loginEmailDisplay').textContent = authState.email;
                validateStep2();
                $('passwordLogin').focus();
            } else if (authState.currentStep === 3) {
                buttonText = 'ê°€ì…í•˜ê¸°';
                $('signupEmailDisplay').textContent = authState.email;
                validateStep3();
                $('passwordSignup').focus();
            } else {
                validateStep1();
                $('emailInput').focus();
            }

            $('nextButton').textContent = buttonText;
        }

        /**
         * ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•˜ê±°ë‚˜ ìµœì¢… ì¸ì¦ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
         */
        async function nextStep() {
            // ë²„íŠ¼ í™œì„±í™”ê°€ ë˜ì–´ ìˆë‹¤ë©´, ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ì€ ìœ íš¨í•˜ë‹¤ê³  ê°€ì •í•˜ê³  ì§„í–‰
            // ë‹¤ë§Œ, ë¡œë”© ì‹œì‘ ì‹œ ë¹„í™œì„±í™”ëŠ” í•„ìˆ˜
            $('nextButton').disabled = true; 
            
            if (authState.currentStep === 1) {
                const email = $('emailInput').value.trim();
                if (!isValidEmail(email)) {
                    showMessage('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    $('nextButton').disabled = false;
                    return;
                }
                authState.email = email;
                
                try {
                    $('loading-text').textContent = 'ì´ë©”ì¼ í™•ì¸ ì¤‘...';
                    $('loading-overlay').style.display = 'flex';
                    
                    // Firebase: ì´ë©”ì¼ì´ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸
                    const methods = await fetchSignInMethodsForEmail(auth, email);

                    if (methods.length > 0) {
                        // ê¸°ì¡´ ì‚¬ìš©ì: ë¡œê·¸ì¸ ë‹¨ê³„ë¡œ ì´ë™
                        authState.currentStep = 2; 
                        showMessage('ê¸°ì¡´ ê³„ì •ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    } else {
                        // ì‹ ê·œ ì‚¬ìš©ì: íšŒì›ê°€ì… ë‹¨ê³„ë¡œ ì´ë™
                        authState.currentStep = 3; 
                        showMessage('ìƒˆ ê³„ì •ì„ ë§Œë“­ë‹ˆë‹¤.');
                    }
                    
                    $('loading-overlay').style.display = 'none';
                    renderStep();

                } catch (error) {
                    console.error("ì´ë©”ì¼ í™•ì¸ ì˜¤ë¥˜:", error);
                    showMessage(`ì˜¤ë¥˜: ${error.message.substring(0, 50)}...`);
                    $('loading-overlay').style.display = 'none';
                } finally {
                    $('nextButton').disabled = false;
                }
                
            } else if (authState.currentStep === 2) {
                // Firebase ë¡œê·¸ì¸ ì‹¤í–‰ (Step 2)
                await executeLogin();
                
            } else if (authState.currentStep === 3) {
                // Firebase íšŒì›ê°€ì… ì‹¤í–‰ (Step 3)
                await executeSignup();
            }
        }

        /**
         * ì´ì „ ë‹¨ê³„ë¡œ ì´ë™í•˜ê±°ë‚˜ ì•±ì„ ë‹«ëŠ” ë™ì‘ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         */
        function handleBack() {
            if (authState.currentStep === 1) {
                // ë‹«ê¸° ë¡œì§ (ë°ëª¨ì—ì„œëŠ” ë©”ì‹œì§€ë§Œ í‘œì‹œ)
                showMessage('ì¸ì¦ í˜ì´ì§€ë¥¼ ë‹«ëŠ” ê¸°ëŠ¥ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.');
            } else if (authState.currentStep === 2 || authState.currentStep === 3) {
                // ë¡œê·¸ì¸/íšŒì›ê°€ì… í˜ì´ì§€ì—ì„œ ë’¤ë¡œê°€ë©´ ì´ë©”ì¼ ì…ë ¥ ë‹¨ê³„ë¡œ ëŒì•„ê°
                authState.currentStep = 1;
                renderStep();
            }
        }
        
        // ------------------ ìœ íš¨ì„± ê²€ì‚¬ (ë²„íŠ¼ í™œì„±í™”) ------------------

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function validateStep1() {
            const email = $('emailInput').value.trim();
            $('nextButton').disabled = !isValidEmail(email);
        }

        function validateStep2() {
            // ë¡œê·¸ì¸: ë¹„ë°€ë²ˆí˜¸ë§Œ 6ì ì´ìƒì¸ì§€ í™•ì¸
            const password = $('passwordLogin').value;
            $('nextButton').disabled = password.length < 6;
        }
        
        function validateStep3() {
            // íšŒì›ê°€ì…: ë¹„ë°€ë²ˆí˜¸(6ì ì´ìƒ) í™•ì¸ (ì´ë¦„ì€ ì„ íƒ ì‚¬í•­ì´ë¯€ë¡œ í•„ìˆ˜ê°€ ì•„ë‹˜)
            const password = $('passwordSignup').value;
            $('nextButton').disabled = password.length < 6;
        }
        
        // ------------------ ìµœì¢… Firebase ì¸ì¦ ë¡œì§ ------------------

        async function executeLogin() {
            const email = authState.email;
            const password = $('passwordLogin').value;
            
            $('nextButton').disabled = true;
            $('nextButton').textContent = 'ë¡œê·¸ì¸ ì¤‘...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage(`âœ… ë¡œê·¸ì¸ ì„±ê³µ! (${email})`);
                // onAuthStateChanged ë¦¬ìŠ¤ë„ˆê°€ ë¦¬ë””ë ‰ì…˜/UI ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•¨
            } catch (error) {
                console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                let errorMessage = 'ë¡œê·¸ì¸ ì‹¤íŒ¨. ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'ì˜ëª»ëœ ì¸ì¦ ì •ë³´ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                }
                showMessage(errorMessage);
            } finally {
                $('nextButton').disabled = false;
                $('nextButton').textContent = 'ë¡œê·¸ì¸';
            }
        }

        async function executeSignup() {
            const email = authState.email;
            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œì˜ ê°’ì„ ëª…ì‹œì ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤. 
            const password = $('passwordSignup').value; 
            const displayName = $('nameInput').value.trim();
            
            $('nextButton').disabled = true;
            $('nextButton').textContent = 'ê°€ì… ì¤‘...';

            // Firebase createUserWithEmailAndPassword í˜¸ì¶œ ì „ì— ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„±ì„ í•œ ë²ˆ ë” ê²€ì‚¬í•©ë‹ˆë‹¤.
            if (password.length < 6) {
                 showMessage('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                 $('nextButton').disabled = false;
                 $('nextButton').textContent = 'ê°€ì…í•˜ê¸°';
                 return;
            }

            try {
                // ë¹„ë°€ë²ˆí˜¸ ë³€ìˆ˜ë¥¼ ì‚¬ìš©
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // ì´ë¦„ì´ ìˆë‹¤ë©´ ì‚¬ìš©ì í”„ë¡œí•„ ì—…ë°ì´íŠ¸ (ì„ íƒ ì‚¬í•­)
                if (displayName) {
                    await updateProfile(userCredential.user, {
                        displayName: displayName
                    });
                }
                
                showMessage(`ğŸ‰ íšŒì›ê°€ì… ì„±ê³µ! ${displayName || email}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
                // onAuthStateChanged ë¦¬ìŠ¤ë„ˆê°€ ë¦¬ë””ë ‰ì…˜/UI ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•¨
            } catch (error) {
                console.error("íšŒì›ê°€ì… ì˜¤ë¥˜:", error);
                let errorMessage = 'íšŒì›ê°€ì… ì‹¤íŒ¨.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                } else if (error.code === 'auth/missing-password') { 
                    errorMessage = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                }
                showMessage(errorMessage);
            } finally {
                $('nextButton').disabled = false;
                $('nextButton').textContent = 'ê°€ì…í•˜ê¸°';
            }
        }

        // ------------------ ìœ í‹¸ë¦¬í‹° ------------------
        
        /**
         * alert() ëŒ€ì‹  ì‚¬ìš©í•  ì‚¬ìš©ì ì •ì˜ ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showMessage(message) {
            const msgBox = $('custom-message');
            msgBox.textContent = message;
            
            msgBox.style.bottom = '20px';
            msgBox.style.opacity = '1';

            setTimeout(() => {
                msgBox.style.bottom = '-100px';
                msgBox.style.opacity = '0';
            }, 3000);
        }

        // ì „ì—­ ë²”ìœ„ì—ì„œ í•¨ìˆ˜ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        window.handleBack = handleBack;
        window.nextStep = nextStep;
        window.validateStep1 = validateStep1;
        window.validateStep2 = validateStep2;
        window.validateStep3 = validateStep3;
        
        // ì•± ì´ˆê¸°í™”
        initFirebase();
    </script>
</body>
</html>
